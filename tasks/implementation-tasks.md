# 音声通知MCP Server 実装タスク

## 概要
macOS専用の音声通知MCPサーバーを実装する。AIが自律的に音声通知を行い、ユーザー体験を向上させる。

## タスク一覧

### 1. プロジェクト初期設定 [Priority: High] ✅ 完了
- [x] Goモジュールの初期化 (`go mod init github.com/kyong0612/voice-notify-mcp`)
- [x] 必要な依存関係の追加 (`github.com/mark3labs/mcp-go`)
- [x] `.gitignore`ファイルの作成
- [x] プロジェクト構造の作成

### 2. MCPサーバー基盤の実装 [Priority: High] ✅ 完了
- [x] `main.go`: エントリーポイントの実装
  - [x] MCPサーバーの初期化
  - [x] シグナルハンドリング
  - [x] グレースフルシャットダウン
- [x] `server.go`: MCPサーバーコア実装
  - [x] MCPプロトコルの実装
  - [x] ツール登録機能
  - [x] リクエスト/レスポンスハンドリング

### 3. 音声通知機能の実装 [Priority: High] ✅ 完了
- [x] `voice.go`: 音声処理ロジック
  - [x] `say`コマンドの実行関数
  - [x] 利用可能な音声一覧の取得（`say -v '?'`）
  - [x] 音声の検証とフォールバック機能
  - [x] コマンドインジェクション対策
- [x] `language.go`: 言語検出ロジック
  - [x] メッセージからの言語自動検出
  - [x] 言語に応じた音声選択
  - [x] デフォルト言語の処理

### 4. 自律的通知機能の実装 [Priority: Medium] ✅ 完了
- [x] `notification.go`: 通知判定ロジック
  - [x] 通知タイミングの判定
  - [x] 優先度に基づく処理
  - [x] 静音時間帯のチェック
  - [x] 連続通知の抑制（レート制限）

### 5. 環境変数管理 [Priority: Medium] ✅ 完了
- [x] 環境変数の読み込み処理
  - [x] `VOICE_NOTIFY_DEFAULT_VOICE`
  - [x] `VOICE_NOTIFY_DEFAULT_LANGUAGE`
  - [x] `VOICE_NOTIFY_AUTO_DETECT_LANGUAGE`
  - [x] `VOICE_NOTIFY_AUTO_NOTIFY`
  - [x] `VOICE_NOTIFY_MIN_TASK_DURATION`
  - [x] `VOICE_NOTIFY_QUIET_HOURS`
- [x] デフォルト値の設定
- [x] 環境変数の検証

### 6. MCPツール定義 [Priority: High] ✅ 完了
- [x] `notify_voice`ツールの実装
  - [x] 入力スキーマの定義
  - [x] パラメータ検証
  - [x] ツール実行ロジック
  - [x] エラーハンドリング

### 7. エラーハンドリングとログ [Priority: Medium] ✅ 完了
- [x] 統一的なエラーハンドリング
- [x] ログ出力の実装
- [x] デバッグモード対応

### 8. テストの実装 [Priority: Medium] ✅ 完了
- [x] 単体テストの作成
  - [x] 音声選択ロジックのテスト
  - [x] 言語検出のテスト  
  - [x] 環境変数処理のテスト
- [x] 統合テストの作成
- [x] モックの実装（`say`コマンド）

### 9. 設定ファイルとドキュメント [Priority: High] ✅ 完了
- [x] `dxt.json`: Desktop Extensions設定
- [x] `README.md`: インストールと使用方法
- [x] サンプル設定ファイルの作成

### 10. リリース準備 [Priority: Low] 🔲 未着手
- [ ] バージョニング戦略の決定
- [ ] リリースワークフローの設定
- [ ] Go module の公開準備

## 実装進捗

### Phase 1: 基本機能 ✅ 完了
- プロジェクトセットアップ完了
- MCPサーバーの基本実装完了
- notify_voiceツールの実装完了

### Phase 2: 音声機能 ✅ 完了
- 音声処理の実装完了
- 環境変数管理完了
- 言語自動検出機能実装

### Phase 3: 高度な機能 ✅ 完了
- 自律的通知機能実装
- エラーハンドリング実装
- レート制限機能実装

### Phase 4: 品質とリリース 🔲 未着手
- テスト実装が必要
- ドキュメント作成は完了
- リリース準備は未着手

## 完了した機能

### コア機能
- ✅ MCPサーバーの起動と停止
- ✅ StdIOトランスポートでの通信
- ✅ notify_voiceツールの実装
- ✅ macOS sayコマンドとの統合

### 音声機能
- ✅ 複数言語の自動検出（日本語、英語、フランス語、スペイン語など）
- ✅ 音声の自動選択とフォールバック
- ✅ 優先度に基づく発話速度の調整
- ✅ インストール済み音声の確認

### 通知管理
- ✅ 静音時間帯のサポート
- ✅ 優先度別のレート制限
- ✅ 環境変数による設定管理

## 技術的な実装詳細

### 使用ライブラリ
- `github.com/mark3labs/mcp-go`: MCP実装
- 標準ライブラリのみでその他の機能を実装

### セキュリティ対策
- ✅ コマンドインジェクション対策実装
- ✅ 入力値のサニタイゼーション
- ✅ ローカル実行のみに制限

### パフォーマンス
- ✅ 音声一覧のキャッシング実装
- ✅ 同期的な音声再生（MCPの性質上）
- ✅ メモリ効率的な実装

## 成功基準
- [x] `go run`コマンドで正常起動
- [x] ビルド成功（`go build -o voice-notify-mcp`）
- [ ] Claude Desktop、Claude Code、Cursor、Windsurfとの連携確認
- [x] 音声通知の正常動作確認（MCPプロトコル経由）
- [ ] 自律的通知の適切な発動確認（AIによる判断）
- [x] エラー時の適切なフォールバック実装

## 次のステップ
1. 実際の環境でのテスト
2. ユニットテストの追加
3. CI/CDの設定
4. リリースタグの作成とGo moduleの公開